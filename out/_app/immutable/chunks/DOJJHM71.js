var Dt=Object.defineProperty;var It=c=>{throw TypeError(c)};var Ct=(c,t,e)=>t in c?Dt(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var g=(c,t,e)=>Ct(c,typeof t!="symbol"?t+"":t,e),wt=(c,t,e)=>t.has(c)||It("Cannot "+e);var s=(c,t,e)=>(wt(c,t,"read from private field"),e?e.call(c):t.get(c)),o=(c,t,e)=>t.has(c)?It("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(c):t.set(c,e);import{j as u,l as a,k as d,y as I}from"./D_6JOOz4.js";import{p as n}from"./Du6CA1sz.js";const Rt="tasks",Lt="invoices",Ut="settings",At="fdfa7987-22fb-4458-896b-d04b30f9ba38";var y,T,v,b,D,C,w,R,L,U,A;class S{constructor(t){o(this,y,u());o(this,T,u(n(navigator.language)));o(this,v,u());o(this,b,u());o(this,D,u(n({})));o(this,C,u(1e3));o(this,w,u());o(this,R,u("USD"));o(this,L,u());o(this,U,u());o(this,A,u());t&&this.applyModel(t)}get label(){return a(s(this,y))}set label(t){d(s(this,y),n(t))}get localeCode(){return a(s(this,T))}set localeCode(t){d(s(this,T),n(t))}get address(){return a(s(this,v))}set address(t){d(s(this,v),n(t))}get logoData(){return a(s(this,b))}set logoData(t){d(s(this,b),n(t))}get scratchPads(){return a(s(this,D))}set scratchPads(t){d(s(this,D),n(t))}get nextInvoiceNumber(){return a(s(this,C))}set nextInvoiceNumber(t){d(s(this,C),n(t))}get defaultInvoiceHeader(){return a(s(this,w))}set defaultInvoiceHeader(t){d(s(this,w),n(t))}get defaultInvoiceCurrencyCode(){return a(s(this,R))}set defaultInvoiceCurrencyCode(t){d(s(this,R),n(t))}get defaultInvoiceFooter(){return a(s(this,L))}set defaultInvoiceFooter(t){d(s(this,L),n(t))}get cloudSyncHost(){return a(s(this,U))}set cloudSyncHost(t){d(s(this,U),n(t))}get cloudSyncUserId(){return a(s(this,A))}set cloudSyncUserId(t){d(s(this,A),n(t))}applyModel(t){this.label=t.label,this.localeCode=t.localeCode??navigator.language,this.address=t.address??"",this.logoData=t.logoData,this.scratchPads=t.scratchPads??{},this.nextInvoiceNumber=t.nextInvoiceNumber??1e3,this.defaultInvoiceHeader=t.defaultInvoiceHeader,this.defaultInvoiceCurrencyCode=t.defaultInvoiceCurrencyCode??"USD",this.defaultInvoiceFooter=t.defaultInvoiceFooter,this.cloudSyncHost=t.cloudSyncHost,this.cloudSyncUserId=t.cloudSyncUserId}getModel(){return{label:this.label,localeCode:this.localeCode,address:this.address,logoData:this.logoData,scratchPads:this.scratchPads,nextInvoiceNumber:this.nextInvoiceNumber,defaultInvoiceHeader:this.defaultInvoiceHeader,defaultInvoiceCurrencyCode:this.defaultInvoiceCurrencyCode,defaultInvoiceFooter:this.defaultInvoiceFooter,cloudSyncHost:this.cloudSyncHost,cloudSyncUserId:this.cloudSyncUserId}}}y=new WeakMap,T=new WeakMap,v=new WeakMap,b=new WeakMap,D=new WeakMap,C=new WeakMap,w=new WeakMap,R=new WeakMap,L=new WeakMap,U=new WeakMap,A=new WeakMap;class St{static padLeft(t,e,i){const r=i-t.length;for(let l=0;l<r;l++)t=e[0]+t;return t}}class lt{static toInputDateValue(t){var e=t.getDate(),i=t.getMonth()+1,r=t.getFullYear();return`${r}-${St.padLeft(i.toString(),"0",2)}-${St.padLeft(e.toString(),"0",2)}`}static toLocalDatefromString(t,e){const i=new Date(t);return lt.toLocalDate(i,e)}static toLocalDate(t,e){return new Intl.DateTimeFormat(e,{}).format(t)}}var k,E,x,M,N,O,K,rt,ot;class yt{constructor(t){o(this,k,u(n(crypto.randomUUID().toString())));o(this,E,u());o(this,x,u(0));o(this,M,u(""));o(this,N,u(""));o(this,O,u(0));o(this,K,u(0));o(this,rt,I(()=>0));o(this,ot,I(()=>this.quantity*this.unitCost));t&&this.applyModel(t)}get id(){return a(s(this,k))}set id(t){d(s(this,k),n(t))}get extRefId(){return a(s(this,E))}set extRefId(t){d(s(this,E),n(t))}get number(){return a(s(this,x))}set number(t){d(s(this,x),n(t))}get description(){return a(s(this,M))}set description(t){d(s(this,M),n(t))}get units(){return a(s(this,N))}set units(t){d(s(this,N),n(t))}get quantity(){return a(s(this,O))}set quantity(t){d(s(this,O),n(t))}get unitCost(){return a(s(this,K))}set unitCost(t){d(s(this,K),n(t))}get tax(){return a(s(this,rt))}get total(){return a(s(this,ot))}get isDescriptionOnlyLine(){return this.quantity==0}getModel(){return{id:this.id,extRefId:this.extRefId,number:this.number,description:this.description,units:this.units,quantity:this.quantity,unitCost:this.unitCost}}applyModel(t){this.id=t.id,this.extRefId=t.extRefId,this.number=t.number,this.description=t.description,this.units=t.units,this.quantity=t.quantity,this.unitCost=t.unitCost}}k=new WeakMap,E=new WeakMap,x=new WeakMap,M=new WeakMap,N=new WeakMap,O=new WeakMap,K=new WeakMap,rt=new WeakMap,ot=new WeakMap;var _,P,H,F,B,V,j,J,$,q,at,ut,dt;class kt{constructor(t){o(this,_,u(n(crypto.randomUUID().toString())));o(this,P,u("USD"));o(this,H,u(""));o(this,F,u(n(lt.toInputDateValue(new Date))));o(this,B,u(""));o(this,V,u(n([])));o(this,j,u(n([])));o(this,J,u(n([])));o(this,$,u(10));o(this,q,u(n([])));o(this,at,I(()=>this.lines.reduce((t,e)=>t+e.total,0)));o(this,ut,I(()=>this.lines.reduce((t,e)=>t+e.tax,0)));o(this,dt,I(()=>this.subtotal+this.taxTotal));t&&this.applyModel(t)}get id(){return a(s(this,_))}set id(t){d(s(this,_),n(t))}get currencyCode(){return a(s(this,P))}set currencyCode(t){d(s(this,P),n(t))}get number(){return a(s(this,H))}set number(t){d(s(this,H),n(t))}get date(){return a(s(this,F))}set date(t){d(s(this,F),n(t))}get orderRef(){return a(s(this,B))}set orderRef(t){d(s(this,B),n(t))}get headerLines(){return a(s(this,V))}set headerLines(t){d(s(this,V),n(t))}get issueToLines(){return a(s(this,j))}set issueToLines(t){d(s(this,j),n(t))}get footerLines(){return a(s(this,J))}set footerLines(t){d(s(this,J),n(t))}get nextLineNumber(){return a(s(this,$))}set nextLineNumber(t){d(s(this,$),n(t))}get lines(){return a(s(this,q))}set lines(t){d(s(this,q),n(t))}get subtotal(){return a(s(this,at))}get taxTotal(){return a(s(this,ut))}get grandTotal(){return a(s(this,dt))}getModel(){return{id:this.id,currencyCode:this.currencyCode,number:this.number,date:this.date,orderRef:this.orderRef,headerLines:this.headerLines,issueToLines:this.issueToLines,lines:this.lines.map(t=>t.getModel()),footerLines:this.footerLines}}applyModel(t){this.id=t.id,this.currencyCode=t.currencyCode,this.number=t.number,this.date=t.date,this.orderRef=t.orderRef,this.headerLines=t.headerLines??[],this.issueToLines=t.issueToLines,this.lines=t.lines.map(e=>new yt(e)),this.footerLines=t.footerLines??[]}get headerLinesAsText(){return this.headerLines.join(`
`)}set headerLinesAsText(t){this.headerLines=t.split(`
`)}get issueToAsText(){return this.issueToLines.join(`
`)}set issueToAsText(t){this.issueToLines=t.split(`
`)}get footnoteAsText(){return this.footerLines.join(`
`)}set footnoteAsText(t){this.footerLines=t.split(`
`)}containsExtRefId(t){return this.lines.some(i=>i.extRefId===t)}removeLineWithId(t){this.lines=this.lines.filter(e=>e.id!=t)}removeLineWithExtRefId(t){this.lines=this.lines.filter(e=>e.extRefId!=t)}addLine(t){const e=t??new yt;return e.number=this.nextLineNumber,this.nextLineNumber+=10,this.lines.push(e),e.id}sortAndRenumberLines(){this.lines.sort((t,e)=>t.number-e.number),this.renumberLines()}renumberLines(){let t=10;for(let e=0;e<this.lines.length;e++){const i=this.lines[e];i.number=t,t+=10}this.nextLineNumber=t}}_=new WeakMap,P=new WeakMap,H=new WeakMap,F=new WeakMap,B=new WeakMap,V=new WeakMap,j=new WeakMap,J=new WeakMap,$=new WeakMap,q=new WeakMap,at=new WeakMap,ut=new WeakMap,dt=new WeakMap;var f=(c=>(c.Running="Running",c.Paused="Paused",c.Stopped="Stopped",c.Archived="Archived",c))(f||{}),W,G,Y,z,Q,X,Z,tt,et;class Et{constructor(t){o(this,W,u(n(crypto.randomUUID())));o(this,G,u(n(f.Stopped)));o(this,Y,u(n(lt.toInputDateValue(new Date))));o(this,z,u(""));o(this,Q,u(0));o(this,X,u(0));o(this,Z,u());o(this,tt,u(""));o(this,et,u(n([])));t&&this.applyModel(t)}get id(){return a(s(this,W))}set id(t){d(s(this,W),n(t))}get state(){return a(s(this,G))}set state(t){d(s(this,G),n(t))}get date(){return a(s(this,Y))}set date(t){d(s(this,Y),n(t))}get name(){return a(s(this,z))}set name(t){d(s(this,z),n(t))}get duration(){return a(s(this,Q))}set duration(t){d(s(this,Q),n(t))}get affectiveDurationHours(){return a(s(this,X))}set affectiveDurationHours(t){d(s(this,X),n(t))}get timeRunStarted(){return a(s(this,Z))}set timeRunStarted(t){d(s(this,Z),n(t))}get invoiceRefId(){return a(s(this,tt))}set invoiceRefId(t){d(s(this,tt),n(t))}get tags(){return a(s(this,et))}set tags(t){d(s(this,et),n(t))}get tagsAsText(){return this.tags.join(" ")}set tagsAsText(t){this.tags=t.trim().split(" ")}getModel(t){return{id:t??this.id,state:this.state,date:this.date,name:this.name,duration:this.duration,affectiveDurationHours:this.affectiveDurationHours,timeRunStarted:this.timeRunStarted,invoiceRefId:this.invoiceRefId,tags:this.tags}}applyModel(t){this.id=t.id,this.state=t.state,this.date=t.date,this.name=t.name,this.duration=t.duration,this.affectiveDurationHours=t.affectiveDurationHours,this.timeRunStarted=t.timeRunStarted,this.invoiceRefId=t.invoiceRefId,this.tags=t.tags}save(){Ot.taskRepo.set(this.id,this.getModel())}pause(){this.state==f.Running&&(this.state=f.Paused,this.timeRunStarted=void 0)}start(){this.state=f.Running,this.timeRunStarted=Date.now()}stop(){this.state=f.Stopped,this.timeRunStarted=void 0}incrementDuration(t){if(this.state==f.Running){const e=this.timeRunStarted??Date.now(),i=t*60*1e3,r=e-i;this.timeRunStarted=r,this.recalculateDurationFromRunningSession()}else this.setDuration(this.duration+t*60)}recalculateDurationFromRunningSession(){if(this.state!=f.Running)return;const t=this.timeRunStarted??Date.now(),e=(Date.now()-t)/1e3;this.setDuration(e)}setDuration(t){this.duration=Math.ceil(t),this.affectiveDurationHours=this.calculateAffectiveHours(this.duration,15)}calculateAffectiveHours(t,e){let i=t/60;return Math.ceil(i/e)*e/60}}W=new WeakMap,G=new WeakMap,Y=new WeakMap,z=new WeakMap,Q=new WeakMap,X=new WeakMap,Z=new WeakMap,tt=new WeakMap,et=new WeakMap;class gt{constructor(t,e){this.bucket=t,this.options=e,this.bucket=t}encode(t){return JSON.stringify(t)}dencode(t){return JSON.parse(t)}buildBucketKey(t){return[this.bucket,t].join("$")}matchesBucketItemKey(t){return t.startsWith(this.bucket+"$")}setChangedTimestamp(){var t;((t=this.options)==null?void 0:t.onModifiedCallback)!=null&&this.options.onModifiedCallback()}set(t,e){const i=this.buildBucketKey(t),r=this.encode(e);localStorage.setItem(i,r),this.setChangedTimestamp()}get(t){const e=this.buildBucketKey(t);return this.getWithKey(e)}getWithKey(t){const e=localStorage.getItem(t);return e===null?null:this.dencode(e)}getAll(){const t=[];for(let e=0;e<localStorage.length;e++){const i=localStorage.key(e);if(i==null)return t;if(!this.matchesBucketItemKey(i))continue;const r=this.getWithKey(i);r&&t.push(r)}return t}remove(t){const e=this.buildBucketKey(t);localStorage.removeItem(e),this.setChangedTimestamp()}removeAll(){const t=[];for(let e=0;e<localStorage.length;e++){const i=localStorage.key(e);if(i==null)break;this.matchesBucketItemKey(i)&&t.push(i)}if(t.length!=0){for(const e of t)localStorage.removeItem(e);this.setChangedTimestamp()}}}const ct=class ct{constructor(t){this.repo=t}read(){const t=this.repo.get("");return t?new S(t):new S(ct.defaultSettings)}write(t){this.repo.set("",t.getModel())}};g(ct,"defaultSettings",{localeCode:"en-US",nextInvoiceNumber:1e3,defaultInvoiceCurrencyCode:"USD",scratchPads:{}});let ft=ct;class Tt{constructor(t,e,i){g(this,"remoteUrl");g(this,"userAndAppPathSegments");const r=URL.parse(t);if(!r)throw new Error(`Invalid remote URL: ${t}`);this.userAndAppPathSegments=[e,i],this.remoteUrl=r}buildFullRemoteUrl(t){const e=new URL(this.remoteUrl);return e.pathname=t.join("/"),e}buildListUrl(t){return this.buildFullRemoteUrl([...this.userAndAppPathSegments,t])}buildItemUrl(t,e){return this.buildFullRemoteUrl([...this.userAndAppPathSegments,t,e])}async getItemList(t){const e=this.buildListUrl(t);return await(await fetch(e)).json()}async getItem(t,e){const i=this.buildItemUrl(t,e);return await(await fetch(i)).text()}async setItem(t,e,i){const r=this.buildItemUrl(t,e);await fetch(r,{method:"POST",body:i})}async delItem(t,e){const i=this.buildItemUrl(t,e);await fetch(i,{method:"DELETE"})}}const vt="default",bt="dataTimestamp",nt="ids",h=class h{constructor(t,e,i){this.host=t,this.userId=e,this.appId=i}static build(t,e,i){return t!=null&&(t.startsWith("https://")||t.startsWith("http://"))&&e!=null&&e.length>0&&i!=null&&i.length>0?new h(t,e,i):null}async backup(t){const e=new Tt(this.host,this.userId,this.appId);await e.setItem(h.BUCKET_ID_META,bt,JSON.stringify(t.modified)),await e.setItem(h.BUCKET_ID_SETTINGS,vt,JSON.stringify(t.settings));const i=t.tasks.map(l=>l.id);await e.setItem(h.BUCKET_ID_TASKS,nt,JSON.stringify(i));for(const l of t.tasks)await e.setItem(h.BUCKET_ID_TASKS,l.id,JSON.stringify(l));const r=t.invoices.map(l=>l.id);await e.setItem(h.BUCKET_ID_INVOICES,nt,JSON.stringify(r));for(const l of t.invoices)await e.setItem(h.BUCKET_ID_INVOICES,l.id,JSON.stringify(l))}async getStoredValueOrDefault(t,e,i,r){try{const l=await t.getItem(e,i);if(l==null)return r;const p=JSON.parse(l);return p??r}catch{return r}}async getStoredValueOrThrow(t,e,i){try{const r=await t.getItem(e,i),l=JSON.parse(r);if(l==null)throw new Error(`Object is undefined after parsing and casting. JSON: ${r}`);return l}catch(r){throw new Error(`Unable to get stored value for key ${i} in bucket ${e}. ${r}`)}}async getData(){const t=new Tt(this.host,this.userId,this.appId),e=await this.getStoredValueOrDefault(t,h.BUCKET_ID_META,bt,0);if(e==0)return null;let i=await this.getStoredValueOrDefault(t,h.BUCKET_ID_SETTINGS,vt,new S().getModel());const r=await this.getStoredValueOrDefault(t,h.BUCKET_ID_TASKS,nt,[]),l=[];for await(const ht of r)try{const m=await this.getStoredValueOrThrow(t,h.BUCKET_ID_TASKS,ht);l.push(m)}catch(m){console.error(m)}const p=await this.getStoredValueOrDefault(t,h.BUCKET_ID_INVOICES,nt,[]),pt=[];for await(const ht of p)try{const m=await this.getStoredValueOrThrow(t,h.BUCKET_ID_INVOICES,ht);pt.push(m)}catch(m){console.error(m)}return{modified:e,settings:i,tasks:l,invoices:pt}}};g(h,"BUCKET_ID_META","meta"),g(h,"BUCKET_ID_SETTINGS","settings"),g(h,"BUCKET_ID_TASKS","tasks"),g(h,"BUCKET_ID_INVOICES","invoices");let mt=h;class xt{static async convertFileToDataURL(t){return new Promise((e,i)=>{const r=new FileReader;r.onloadend=()=>{const l=r.result;return e(l)},r.onerror=i,r.readAsDataURL(t)})}static downloadAsFile(t,e){const i=new Blob([t],{type:"text/plain"}),r=document.createElement("a");r.href=URL.createObjectURL(i),r.download=e,r.click(),URL.revokeObjectURL(r.href)}}class Mt{async backup(t){const e=this.encode(t);this.downloadAsFile(e,t.settings.label)}downloadAsFile(t,e){const r=`${e?`${e}-`:""}${new Date().valueOf()}.timely-backup`;xt.downloadAsFile(t,r)}encode(t){return JSON.stringify(t,null,2)}decodeFromJson(t){return JSON.parse(t)}}var st,it;class Nt{constructor(){g(this,"settingsRepo");g(this,"taskRepo");g(this,"invRepo");g(this,"settingsController");o(this,st,u(0));o(this,it,u(n(new S)));const t={onModifiedCallback:()=>this.setChangedTimestamp()};this.settingsRepo=new gt(Ut,t),this.taskRepo=new gt(Rt,t),this.invRepo=new gt(Lt,t),this.settingsController=new ft(this.settingsRepo),this.settings=this.settingsController.read(),this.dataModifiedTimestamp=this.readDataModifiedTimestamp()??0}get dataModifiedTimestamp(){return a(s(this,st))}set dataModifiedTimestamp(t){d(s(this,st),n(t))}get settings(){return a(s(this,it))}set settings(t){d(s(this,it),n(t))}saveSettings(){this.settingsController.write(this.settings)}getScratchPad(t){return this.settings.scratchPads[t]??""}setScratchPad(t,e){this.settings.scratchPads[t]=e,this.saveSettings()}incrementNextInvoiceNumber(){this.settings.nextInvoiceNumber++,this.saveSettings()}async getTasks(){return this.taskRepo.getAll().map(t=>new Et(t))}async getInvoices(){return this.invRepo.getAll().map(t=>new kt(t))}getAppData(){return{modified:this.readDataModifiedTimestamp()??0,settings:this.settingsController.read().getModel(),tasks:this.taskRepo.getAll(),invoices:this.invRepo.getAll()}}setChangedTimestamp(t){this.dataModifiedTimestamp=t??new Date().valueOf(),localStorage.setItem("_modified",this.dataModifiedTimestamp.toString())}readDataModifiedTimestamp(){const t=localStorage.getItem("_modified");if(t===null)return null;const e=parseInt(t);return isNaN(e)?null:(this.dataModifiedTimestamp=e,e)}async backupData(t){const e=this.getAppData(),i=this.settingsController.read(),r=mt.build(i.cloudSyncHost,i.cloudSyncUserId,At);if((t==="auto"||t==="cloud")&&r!=null){const l=await r.getData();if(l&&l.modified>=e.modified){await this.backupData("local");return}await r.backup(e),alert("Backup to cloud successful")}else t==="local"&&await new Mt().backup(e)}async restoreAppData(t){localStorage.clear(),this.setChangedTimestamp(t.modified),this.settings=new S(t.settings),this.saveSettings();for(const e of t.tasks)this.taskRepo.set(e.id,e);for(const e of t.invoices)this.invRepo.set(e.id,e)}}st=new WeakMap,it=new WeakMap;const Ot=new Nt;export{lt as F,kt as I,Tt as K,Mt as L,f as T,xt as U,Ot as a,At as b,mt as c,Et as d,yt as e};
