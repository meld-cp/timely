var lt=Object.defineProperty;var rt=u=>{throw TypeError(u)};var gt=(u,t,s)=>t in u?lt(u,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):u[t]=s;var g=(u,t,s)=>gt(u,typeof t!="symbol"?t+"":t,s),ft=(u,t,s)=>t.has(u)||rt("Cannot "+s);var e=(u,t,s)=>(ft(u,t,"read from private field"),s?s.call(u):t.get(u)),n=(u,t,s)=>t.has(u)?rt("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(u):t.set(u,s);import{j as o,l as r,k as a,y as f}from"./Cxm-zCzI.js";import{p as i}from"./B1dRQCFu.js";const ot="tasks",at="invoices",ut="settings",Lt="fdfa7987-22fb-4458-896b-d04b30f9ba38";var v,y,I,p,S,m,R,b,L,C;class nt{constructor(t){n(this,v,o(i(navigator.language)));n(this,y,o());n(this,I,o());n(this,p,o(1e3));n(this,S,o(i({})));n(this,m,o());n(this,R,o("USD"));n(this,b,o());n(this,L,o());n(this,C,o());t&&this.applyModel(t)}get localeCode(){return r(e(this,v))}set localeCode(t){a(e(this,v),i(t))}get address(){return r(e(this,y))}set address(t){a(e(this,y),i(t))}get logoData(){return r(e(this,I))}set logoData(t){a(e(this,I),i(t))}get nextInvoiceNumber(){return r(e(this,p))}set nextInvoiceNumber(t){a(e(this,p),i(t))}get scratchPads(){return r(e(this,S))}set scratchPads(t){a(e(this,S),i(t))}get defaultInvoiceHeader(){return r(e(this,m))}set defaultInvoiceHeader(t){a(e(this,m),i(t))}get defaultInvoiceCurrencyCode(){return r(e(this,R))}set defaultInvoiceCurrencyCode(t){a(e(this,R),i(t))}get defaultInvoiceFooter(){return r(e(this,b))}set defaultInvoiceFooter(t){a(e(this,b),i(t))}get cloudSyncHost(){return r(e(this,L))}set cloudSyncHost(t){a(e(this,L),i(t))}get cloudSyncUserId(){return r(e(this,C))}set cloudSyncUserId(t){a(e(this,C),i(t))}applyModel(t){this.localeCode=t.localeCode??navigator.language,this.address=t.address??"",this.logoData=t.logoData,this.nextInvoiceNumber=t.nextInvoiceNumber??1e3,this.defaultInvoiceHeader=t.defaultInvoiceHeader,this.defaultInvoiceCurrencyCode=t.defaultInvoiceCurrencyCode??"USD",this.defaultInvoiceFooter=t.defaultInvoiceFooter,this.scratchPads=t.scratchPads??{},this.cloudSyncHost=t.cloudSyncHost,this.cloudSyncUserId=t.cloudSyncUserId}getModel(){return{localeCode:this.localeCode,address:this.address,logoData:this.logoData,nextInvoiceNumber:this.nextInvoiceNumber,defaultInvoiceHeader:this.defaultInvoiceHeader,defaultInvoiceCurrencyCode:this.defaultInvoiceCurrencyCode,defaultInvoiceFooter:this.defaultInvoiceFooter,scratchPads:this.scratchPads,cloudSyncHost:this.cloudSyncHost,cloudSyncUserId:this.cloudSyncUserId}}}v=new WeakMap,y=new WeakMap,I=new WeakMap,p=new WeakMap,S=new WeakMap,m=new WeakMap,R=new WeakMap,b=new WeakMap,L=new WeakMap,C=new WeakMap;class ct{static padLeft(t,s,c){const d=c-t.length;for(let h=0;h<d;h++)t=s[0]+t;return t}}class it{static toInputDateValue(t){var s=t.getDate(),c=t.getMonth()+1,d=t.getFullYear();return`${d}-${ct.padLeft(c.toString(),"0",2)}-${ct.padLeft(s.toString(),"0",2)}`}static toLocalDatefromString(t,s){const c=new Date(t);return it.toLocalDate(c,s)}static toLocalDate(t,s){return new Intl.DateTimeFormat(s,{}).format(t)}}var D,x,T,A,k,w,M,X,Z;class dt{constructor(t){n(this,D,o(i(crypto.randomUUID().toString())));n(this,x,o());n(this,T,o(0));n(this,A,o(""));n(this,k,o(""));n(this,w,o(0));n(this,M,o(0));n(this,X,f(()=>0));n(this,Z,f(()=>this.quantity*this.unitCost));t&&this.applyModel(t)}get id(){return r(e(this,D))}set id(t){a(e(this,D),i(t))}get extRefId(){return r(e(this,x))}set extRefId(t){a(e(this,x),i(t))}get number(){return r(e(this,T))}set number(t){a(e(this,T),i(t))}get description(){return r(e(this,A))}set description(t){a(e(this,A),i(t))}get units(){return r(e(this,k))}set units(t){a(e(this,k),i(t))}get quantity(){return r(e(this,w))}set quantity(t){a(e(this,w),i(t))}get unitCost(){return r(e(this,M))}set unitCost(t){a(e(this,M),i(t))}get tax(){return r(e(this,X))}get total(){return r(e(this,Z))}get isDescriptionOnlyLine(){return this.quantity==0}getModel(){return{id:this.id,extRefId:this.extRefId,number:this.number,description:this.description,units:this.units,quantity:this.quantity,unitCost:this.unitCost}}applyModel(t){this.id=t.id,this.extRefId=t.extRefId,this.number=t.number,this.description=t.description,this.units=t.units,this.quantity=t.quantity,this.unitCost=t.unitCost}}D=new WeakMap,x=new WeakMap,T=new WeakMap,A=new WeakMap,k=new WeakMap,w=new WeakMap,M=new WeakMap,X=new WeakMap,Z=new WeakMap;var N,H,P,U,F,K,O,E,_,q,tt,et,st;class vt{constructor(t){n(this,N,o(i(crypto.randomUUID().toString())));n(this,H,o("USD"));n(this,P,o(""));n(this,U,o(i(it.toInputDateValue(new Date))));n(this,F,o(""));n(this,K,o(i([])));n(this,O,o(i([])));n(this,E,o(i([])));n(this,_,o(10));n(this,q,o(i([])));n(this,tt,f(()=>this.lines.reduce((t,s)=>t+s.total,0)));n(this,et,f(()=>this.lines.reduce((t,s)=>t+s.tax,0)));n(this,st,f(()=>this.subtotal+this.taxTotal));t&&this.applyModel(t)}get id(){return r(e(this,N))}set id(t){a(e(this,N),i(t))}get currencyCode(){return r(e(this,H))}set currencyCode(t){a(e(this,H),i(t))}get number(){return r(e(this,P))}set number(t){a(e(this,P),i(t))}get date(){return r(e(this,U))}set date(t){a(e(this,U),i(t))}get orderRef(){return r(e(this,F))}set orderRef(t){a(e(this,F),i(t))}get headerLines(){return r(e(this,K))}set headerLines(t){a(e(this,K),i(t))}get issueToLines(){return r(e(this,O))}set issueToLines(t){a(e(this,O),i(t))}get footerLines(){return r(e(this,E))}set footerLines(t){a(e(this,E),i(t))}get nextLineNumber(){return r(e(this,_))}set nextLineNumber(t){a(e(this,_),i(t))}get lines(){return r(e(this,q))}set lines(t){a(e(this,q),i(t))}get subtotal(){return r(e(this,tt))}get taxTotal(){return r(e(this,et))}get grandTotal(){return r(e(this,st))}getModel(){return{id:this.id,currencyCode:this.currencyCode,number:this.number,date:this.date,orderRef:this.orderRef,headerLines:this.headerLines,issueToLines:this.issueToLines,lines:this.lines.map(t=>t.getModel()),footerLines:this.footerLines}}applyModel(t){this.id=t.id,this.currencyCode=t.currencyCode,this.number=t.number,this.date=t.date,this.orderRef=t.orderRef,this.headerLines=t.headerLines??[],this.issueToLines=t.issueToLines,this.lines=t.lines.map(s=>new dt(s)),this.footerLines=t.footerLines??[]}get headerLinesAsText(){return this.headerLines.join(`
`)}set headerLinesAsText(t){this.headerLines=t.split(`
`)}get issueToAsText(){return this.issueToLines.join(`
`)}set issueToAsText(t){this.issueToLines=t.split(`
`)}get footnoteAsText(){return this.footerLines.join(`
`)}set footnoteAsText(t){this.footerLines=t.split(`
`)}containsExtRefId(t){return this.lines.some(c=>c.extRefId===t)}removeLineWithId(t){this.lines=this.lines.filter(s=>s.id!=t)}removeLineWithExtRefId(t){this.lines=this.lines.filter(s=>s.extRefId!=t)}addLine(t){const s=t??new dt;return s.number=this.nextLineNumber,this.nextLineNumber+=10,this.lines.push(s),s.id}sortAndRenumberLines(){this.lines.sort((t,s)=>t.number-s.number),this.renumberLines()}renumberLines(){let t=10;for(let s=0;s<this.lines.length;s++){const c=this.lines[s];c.number=t,t+=10}this.nextLineNumber=t}}N=new WeakMap,H=new WeakMap,P=new WeakMap,U=new WeakMap,F=new WeakMap,K=new WeakMap,O=new WeakMap,E=new WeakMap,_=new WeakMap,q=new WeakMap,tt=new WeakMap,et=new WeakMap,st=new WeakMap;var l=(u=>(u.Running="Running",u.Paused="Paused",u.Stopped="Stopped",u.Archived="Archived",u))(l||{}),V,j,B,W,$,J,G,Y,z;class yt{constructor(t){n(this,V,o(i(crypto.randomUUID())));n(this,j,o(i(l.Stopped)));n(this,B,o(i(it.toInputDateValue(new Date))));n(this,W,o(""));n(this,$,o(0));n(this,J,o(0));n(this,G,o());n(this,Y,o(""));n(this,z,o(i([])));t&&this.applyModel(t)}get id(){return r(e(this,V))}set id(t){a(e(this,V),i(t))}get state(){return r(e(this,j))}set state(t){a(e(this,j),i(t))}get date(){return r(e(this,B))}set date(t){a(e(this,B),i(t))}get name(){return r(e(this,W))}set name(t){a(e(this,W),i(t))}get duration(){return r(e(this,$))}set duration(t){a(e(this,$),i(t))}get affectiveDurationHours(){return r(e(this,J))}set affectiveDurationHours(t){a(e(this,J),i(t))}get timeRunStarted(){return r(e(this,G))}set timeRunStarted(t){a(e(this,G),i(t))}get invoiceRefId(){return r(e(this,Y))}set invoiceRefId(t){a(e(this,Y),i(t))}get tags(){return r(e(this,z))}set tags(t){a(e(this,z),i(t))}get tagsAsText(){return this.tags.join(" ")}set tagsAsText(t){this.tags=t.trim().split(" ")}getModel(t){return{id:t??this.id,state:this.state,date:this.date,name:this.name,duration:this.duration,affectiveDurationHours:this.affectiveDurationHours,timeRunStarted:this.timeRunStarted,invoiceRefId:this.invoiceRefId,tags:this.tags}}applyModel(t){this.id=t.id,this.state=t.state,this.date=t.date,this.name=t.name,this.duration=t.duration,this.affectiveDurationHours=t.affectiveDurationHours,this.timeRunStarted=t.timeRunStarted,this.invoiceRefId=t.invoiceRefId,this.tags=t.tags}save(){pt.taskRepo.set(this.id,this.getModel())}pause(){this.state==l.Running&&(this.state=l.Paused,this.timeRunStarted=void 0)}start(){this.state=l.Running,this.timeRunStarted=Date.now()}stop(){this.state=l.Stopped,this.timeRunStarted=void 0}incrementDuration(t){if(this.state==l.Running){const s=this.timeRunStarted??Date.now(),c=t*60*1e3,d=s-c;this.timeRunStarted=d,this.recalculateDurationFromRunningSession()}else this.setDuration(this.duration+t*60)}recalculateDurationFromRunningSession(){if(this.state!=l.Running)return;const t=this.timeRunStarted??Date.now(),s=(Date.now()-t)/1e3;this.setDuration(s)}setDuration(t){this.duration=Math.ceil(t),this.affectiveDurationHours=this.calculateAffectiveHours(this.duration,15)}calculateAffectiveHours(t,s){let c=t/60;return Math.ceil(c/s)*s/60}}V=new WeakMap,j=new WeakMap,B=new WeakMap,W=new WeakMap,$=new WeakMap,J=new WeakMap,G=new WeakMap,Y=new WeakMap,z=new WeakMap;class Q{constructor(t){g(this,"bucket");this.bucket=t}encode(t){return JSON.stringify(t)}dencode(t){return JSON.parse(t)}buildBucketKey(t){return[this.bucket,t].join("$")}matchesBucketKey(t){return t.startsWith(this.bucket+"$")}set(t,s){const c=this.buildBucketKey(t),d=this.encode(s);localStorage.setItem(c,d)}get(t,s){const c=this.buildBucketKey(t);return this.getWithKey(c)}getWithKey(t){const s=localStorage.getItem(t);return s===null?null:this.dencode(s)}getAll(){const t=[];for(let s=0;s<localStorage.length;s++){const c=localStorage.key(s);if(c==null)return t;if(!this.matchesBucketKey(c))continue;const d=this.getWithKey(c);d&&t.push(d)}return t}remove(t){const s=this.buildBucketKey(t);localStorage.removeItem(s)}removeAll(){const t=[];for(let s=0;s<localStorage.length;s++){const c=localStorage.key(s);if(c==null)break;this.matchesBucketKey(c)&&t.push(c)}for(const s of t)localStorage.removeItem(s)}}class ht{constructor(){g(this,"defaultSettings",{localeCode:navigator.language,nextInvoiceNumber:1e3,defaultInvoiceCurrencyCode:"USD",scratchPads:{}})}modify(t){const s=this.read();t(s),this.write(s)}read(){const t=localStorage.getItem(ut);return t?new nt(JSON.parse(t)||this.defaultSettings):new nt(this.defaultSettings)}write(t){const s=JSON.stringify(t.getModel());localStorage.setItem(ut,s)}incrementNextInvoiceNumber(){this.modify(t=>{t.nextInvoiceNumber++})}getScratchPad(t){return this.read().scratchPads[t]??""}setScratchPad(t,s){this.modify(c=>{c.scratchPads[t]=s})}}class It{constructor(){g(this,"taskRepo",new Q(ot));g(this,"invRepo",new Q(at));g(this,"settingsController",new ht)}async getTasks(){return this.taskRepo.getAll().map(t=>new yt(t))}async getInvoices(){return this.invRepo.getAll().map(t=>new vt(t))}getAppData(){return{settings:this.settingsController.read().getModel(),tasks:this.taskRepo.getAll(),invoices:this.invRepo.getAll()}}async restoreAppData(t){console.debug("this.restore",t),localStorage.clear(),new ht().write(new nt(t.settings));const c=new Q(ot);for(const h of t.tasks)c.set(h.id,h);const d=new Q(at);for(const h of t.invoices)d.set(h.id,h)}}const pt=new It;export{it as F,vt as I,Lt as K,l as T,pt as a,yt as b,dt as c};
