var Ct=Object.defineProperty;var It=d=>{throw TypeError(d)};var Rt=(d,t,e)=>t in d?Ct(d,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[t]=e;var f=(d,t,e)=>Rt(d,typeof t!="symbol"?t+"":t,e),wt=(d,t,e)=>t.has(d)||It("Cannot "+e);var s=(d,t,e)=>(wt(d,t,"read from private field"),e?e.call(d):t.get(d)),o=(d,t,e)=>t.has(d)?It("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(d):t.set(d,e);import{j as u,l as a,k as c,y}from"./D_6JOOz4.js";import{p as n}from"./Du6CA1sz.js";const Lt="tasks",At="invoices",Ut="settings",kt="fdfa7987-22fb-4458-896b-d04b30f9ba38";var T,b,D,C,R,w,L,A,U,k,E;class v{constructor(t){o(this,T,u());o(this,b,u(n(navigator.language)));o(this,D,u());o(this,C,u());o(this,R,u(n({})));o(this,w,u(1e3));o(this,L,u());o(this,A,u("USD"));o(this,U,u());o(this,k,u());o(this,E,u());t&&this.applyModel(t)}get label(){return a(s(this,T))}set label(t){c(s(this,T),n(t))}get localeCode(){return a(s(this,b))}set localeCode(t){c(s(this,b),n(t))}get address(){return a(s(this,D))}set address(t){c(s(this,D),n(t))}get logoData(){return a(s(this,C))}set logoData(t){c(s(this,C),n(t))}get scratchPads(){return a(s(this,R))}set scratchPads(t){c(s(this,R),n(t))}get nextInvoiceNumber(){return a(s(this,w))}set nextInvoiceNumber(t){c(s(this,w),n(t))}get defaultInvoiceHeader(){return a(s(this,L))}set defaultInvoiceHeader(t){c(s(this,L),n(t))}get defaultInvoiceCurrencyCode(){return a(s(this,A))}set defaultInvoiceCurrencyCode(t){c(s(this,A),n(t))}get defaultInvoiceFooter(){return a(s(this,U))}set defaultInvoiceFooter(t){c(s(this,U),n(t))}get cloudSyncHost(){return a(s(this,k))}set cloudSyncHost(t){c(s(this,k),n(t))}get cloudSyncUserId(){return a(s(this,E))}set cloudSyncUserId(t){c(s(this,E),n(t))}applyModel(t){this.label=t.label,this.localeCode=t.localeCode??navigator.language,this.address=t.address??"",this.logoData=t.logoData,this.scratchPads=t.scratchPads??{},this.nextInvoiceNumber=t.nextInvoiceNumber??1e3,this.defaultInvoiceHeader=t.defaultInvoiceHeader,this.defaultInvoiceCurrencyCode=t.defaultInvoiceCurrencyCode??"USD",this.defaultInvoiceFooter=t.defaultInvoiceFooter,this.cloudSyncHost=t.cloudSyncHost,this.cloudSyncUserId=t.cloudSyncUserId}getModel(){return{label:this.label,localeCode:this.localeCode,address:this.address,logoData:this.logoData,scratchPads:this.scratchPads,nextInvoiceNumber:this.nextInvoiceNumber,defaultInvoiceHeader:this.defaultInvoiceHeader,defaultInvoiceCurrencyCode:this.defaultInvoiceCurrencyCode,defaultInvoiceFooter:this.defaultInvoiceFooter,cloudSyncHost:this.cloudSyncHost,cloudSyncUserId:this.cloudSyncUserId}}}T=new WeakMap,b=new WeakMap,D=new WeakMap,C=new WeakMap,R=new WeakMap,w=new WeakMap,L=new WeakMap,A=new WeakMap,U=new WeakMap,k=new WeakMap,E=new WeakMap;class St{static padLeft(t,e,i){const r=i-t.length;for(let l=0;l<r;l++)t=e[0]+t;return t}}class ft{static toInputDateValue(t){var e=t.getDate(),i=t.getMonth()+1,r=t.getFullYear();return`${r}-${St.padLeft(i.toString(),"0",2)}-${St.padLeft(e.toString(),"0",2)}`}static toLocalDatefromString(t,e){const i=new Date(t);return ft.toLocalDate(i,e)}static toLocalDate(t,e){return new Intl.DateTimeFormat(e,{}).format(t)}}var x,M,N,O,K,_,P,at,ut;class yt{constructor(t){o(this,x,u(n(crypto.randomUUID().toString())));o(this,M,u());o(this,N,u(0));o(this,O,u(""));o(this,K,u(""));o(this,_,u(0));o(this,P,u(0));o(this,at,y(()=>0));o(this,ut,y(()=>this.quantity*this.unitCost));t&&this.applyModel(t)}get id(){return a(s(this,x))}set id(t){c(s(this,x),n(t))}get extRefId(){return a(s(this,M))}set extRefId(t){c(s(this,M),n(t))}get number(){return a(s(this,N))}set number(t){c(s(this,N),n(t))}get description(){return a(s(this,O))}set description(t){c(s(this,O),n(t))}get units(){return a(s(this,K))}set units(t){c(s(this,K),n(t))}get quantity(){return a(s(this,_))}set quantity(t){c(s(this,_),n(t))}get unitCost(){return a(s(this,P))}set unitCost(t){c(s(this,P),n(t))}get tax(){return a(s(this,at))}get total(){return a(s(this,ut))}get isDescriptionOnlyLine(){return this.quantity==0}getModel(){return{id:this.id,extRefId:this.extRefId,number:this.number,description:this.description,units:this.units,quantity:this.quantity,unitCost:this.unitCost}}applyModel(t){this.id=t.id,this.extRefId=t.extRefId,this.number=t.number,this.description=t.description,this.units=t.units,this.quantity=t.quantity,this.unitCost=t.unitCost}}x=new WeakMap,M=new WeakMap,N=new WeakMap,O=new WeakMap,K=new WeakMap,_=new WeakMap,P=new WeakMap,at=new WeakMap,ut=new WeakMap;var H,B,F,V,j,J,$,q,W,G,ct,dt,lt;class vt{constructor(t){o(this,H,u(n(crypto.randomUUID().toString())));o(this,B,u("USD"));o(this,F,u(""));o(this,V,u(n(ft.toInputDateValue(new Date))));o(this,j,u(""));o(this,J,u(n([])));o(this,$,u(n([])));o(this,q,u(n([])));o(this,W,u(10));o(this,G,u(n([])));o(this,ct,y(()=>this.lines.reduce((t,e)=>t+e.total,0)));o(this,dt,y(()=>this.lines.reduce((t,e)=>t+e.tax,0)));o(this,lt,y(()=>this.subtotal+this.taxTotal));t&&this.applyModel(t)}get id(){return a(s(this,H))}set id(t){c(s(this,H),n(t))}get currencyCode(){return a(s(this,B))}set currencyCode(t){c(s(this,B),n(t))}get number(){return a(s(this,F))}set number(t){c(s(this,F),n(t))}get date(){return a(s(this,V))}set date(t){c(s(this,V),n(t))}get orderRef(){return a(s(this,j))}set orderRef(t){c(s(this,j),n(t))}get headerLines(){return a(s(this,J))}set headerLines(t){c(s(this,J),n(t))}get issueToLines(){return a(s(this,$))}set issueToLines(t){c(s(this,$),n(t))}get footerLines(){return a(s(this,q))}set footerLines(t){c(s(this,q),n(t))}get nextLineNumber(){return a(s(this,W))}set nextLineNumber(t){c(s(this,W),n(t))}get lines(){return a(s(this,G))}set lines(t){c(s(this,G),n(t))}get subtotal(){return a(s(this,ct))}get taxTotal(){return a(s(this,dt))}get grandTotal(){return a(s(this,lt))}getModel(){return{id:this.id,currencyCode:this.currencyCode,number:this.number,date:this.date,orderRef:this.orderRef,headerLines:this.headerLines,issueToLines:this.issueToLines,lines:this.lines.map(t=>t.getModel()),footerLines:this.footerLines}}applyModel(t){this.id=t.id,this.currencyCode=t.currencyCode,this.number=t.number,this.date=t.date,this.orderRef=t.orderRef,this.headerLines=t.headerLines??[],this.issueToLines=t.issueToLines,this.lines=t.lines.map(e=>new yt(e)),this.footerLines=t.footerLines??[]}get headerLinesAsText(){return this.headerLines.join(`
`)}set headerLinesAsText(t){this.headerLines=t.split(`
`)}get issueToAsText(){return this.issueToLines.join(`
`)}set issueToAsText(t){this.issueToLines=t.split(`
`)}get footnoteAsText(){return this.footerLines.join(`
`)}set footnoteAsText(t){this.footerLines=t.split(`
`)}containsExtRefId(t){return this.lines.some(i=>i.extRefId===t)}removeLineWithId(t){this.lines=this.lines.filter(e=>e.id!=t)}removeLineWithExtRefId(t){this.lines=this.lines.filter(e=>e.extRefId!=t)}addLine(t){const e=t??new yt;return e.number=this.nextLineNumber,this.nextLineNumber+=10,this.lines.push(e),e.id}sortAndRenumberLines(){this.lines.sort((t,e)=>t.number-e.number),this.renumberLines()}renumberLines(){let t=10;for(let e=0;e<this.lines.length;e++){const i=this.lines[e];i.number=t,t+=10}this.nextLineNumber=t}}H=new WeakMap,B=new WeakMap,F=new WeakMap,V=new WeakMap,j=new WeakMap,J=new WeakMap,$=new WeakMap,q=new WeakMap,W=new WeakMap,G=new WeakMap,ct=new WeakMap,dt=new WeakMap,lt=new WeakMap;var m=(d=>(d.Running="Running",d.Paused="Paused",d.Stopped="Stopped",d.Archived="Archived",d))(m||{}),Y,z,Q,X,Z,tt,et,st,it;class Et{constructor(t){o(this,Y,u(n(crypto.randomUUID())));o(this,z,u(n(m.Stopped)));o(this,Q,u(n(ft.toInputDateValue(new Date))));o(this,X,u(""));o(this,Z,u(0));o(this,tt,u(0));o(this,et,u());o(this,st,u(""));o(this,it,u(n([])));t&&this.applyModel(t)}get id(){return a(s(this,Y))}set id(t){c(s(this,Y),n(t))}get state(){return a(s(this,z))}set state(t){c(s(this,z),n(t))}get date(){return a(s(this,Q))}set date(t){c(s(this,Q),n(t))}get name(){return a(s(this,X))}set name(t){c(s(this,X),n(t))}get duration(){return a(s(this,Z))}set duration(t){c(s(this,Z),n(t))}get affectiveDurationHours(){return a(s(this,tt))}set affectiveDurationHours(t){c(s(this,tt),n(t))}get timeRunStarted(){return a(s(this,et))}set timeRunStarted(t){c(s(this,et),n(t))}get invoiceRefId(){return a(s(this,st))}set invoiceRefId(t){c(s(this,st),n(t))}get tags(){return a(s(this,it))}set tags(t){c(s(this,it),n(t))}get tagsAsText(){return this.tags.join(" ")}set tagsAsText(t){this.tags=t.trim().split(" ")}getModel(t){return{id:t??this.id,state:this.state,date:this.date,name:this.name,duration:this.duration,affectiveDurationHours:this.affectiveDurationHours,timeRunStarted:this.timeRunStarted,invoiceRefId:this.invoiceRefId,tags:this.tags}}applyModel(t){this.id=t.id,this.state=t.state,this.date=t.date,this.name=t.name,this.duration=t.duration,this.affectiveDurationHours=t.affectiveDurationHours,this.timeRunStarted=t.timeRunStarted,this.invoiceRefId=t.invoiceRefId,this.tags=t.tags}save(){Ot.taskRepo.set(this.id,this.getModel())}pause(){this.state==m.Running&&(this.state=m.Paused,this.timeRunStarted=void 0)}start(){this.state=m.Running,this.timeRunStarted=Date.now()}stop(){this.state=m.Stopped,this.timeRunStarted=void 0}archive(){this.state=m.Archived,this.timeRunStarted=void 0}incrementDuration(t){if(this.state==m.Running){const e=this.timeRunStarted??Date.now(),i=t*60*1e3,r=e-i;this.timeRunStarted=r,this.recalculateDurationFromRunningSession()}else this.setDuration(this.duration+t*60)}recalculateDurationFromRunningSession(){if(this.state!=m.Running)return;const t=this.timeRunStarted??Date.now(),e=(Date.now()-t)/1e3;this.setDuration(e)}setDuration(t){this.duration=Math.ceil(t),this.affectiveDurationHours=this.calculateAffectiveHours(this.duration,15)}calculateAffectiveHours(t,e){let i=t/60;return Math.ceil(i/e)*e/60}}Y=new WeakMap,z=new WeakMap,Q=new WeakMap,X=new WeakMap,Z=new WeakMap,tt=new WeakMap,et=new WeakMap,st=new WeakMap,it=new WeakMap;class gt{constructor(t,e){this.bucket=t,this.options=e,this.bucket=t}encode(t){return JSON.stringify(t)}dencode(t){return JSON.parse(t)}buildBucketKey(t){return[this.bucket,t].join("$")}matchesBucketItemKey(t){return t.startsWith(this.bucket+"$")}setChangedTimestamp(){var t;((t=this.options)==null?void 0:t.onModifiedCallback)!=null&&this.options.onModifiedCallback()}set(t,e){const i=this.buildBucketKey(t),r=this.encode(e);localStorage.setItem(i,r),this.setChangedTimestamp()}get(t){const e=this.buildBucketKey(t);return this.getWithKey(e)}getWithKey(t){const e=localStorage.getItem(t);return e===null?null:this.dencode(e)}getAll(){const t=[];for(let e=0;e<localStorage.length;e++){const i=localStorage.key(e);if(i==null)return t;if(!this.matchesBucketItemKey(i))continue;const r=this.getWithKey(i);r&&t.push(r)}return t}remove(t){const e=this.buildBucketKey(t);localStorage.removeItem(e),this.setChangedTimestamp()}removeAll(){const t=[];for(let e=0;e<localStorage.length;e++){const i=localStorage.key(e);if(i==null)break;this.matchesBucketItemKey(i)&&t.push(i)}if(t.length!=0){for(const e of t)localStorage.removeItem(e);this.setChangedTimestamp()}}}const ht=class ht{constructor(t){this.repo=t}read(){const t=this.repo.get("");return t?new v(t):new v(ht.defaultSettings)}write(t){this.repo.set("",t.getModel())}};f(ht,"defaultSettings",{localeCode:"en-US",nextInvoiceNumber:1e3,defaultInvoiceCurrencyCode:"USD",scratchPads:{}});let mt=ht;class Tt{constructor(t,e,i){f(this,"remoteUrl");f(this,"userAndAppPathSegments");const r=URL.parse(t);if(!r)throw new Error(`Invalid remote URL: ${t}`);this.userAndAppPathSegments=[e,i],this.remoteUrl=r}buildFullRemoteUrl(t){const e=new URL(this.remoteUrl);return e.pathname=t.join("/"),e}buildListUrl(t){return this.buildFullRemoteUrl([...this.userAndAppPathSegments,t])}buildItemUrl(t,e){return this.buildFullRemoteUrl([...this.userAndAppPathSegments,t,e])}async getItemList(t){const e=this.buildListUrl(t);return await(await fetch(e)).json()}async getItem(t,e){const i=this.buildItemUrl(t,e);return await(await fetch(i)).text()}async setItem(t,e,i){const r=this.buildItemUrl(t,e);await fetch(r,{method:"POST",body:i})}async delItem(t,e){const i=this.buildItemUrl(t,e);await fetch(i,{method:"DELETE"})}}const bt="default",Dt="dataTimestamp",ot="ids",h=class h{constructor(t,e,i){this.host=t,this.userId=e,this.appId=i}static build(t,e,i){return t!=null&&(t.startsWith("https://")||t.startsWith("http://"))&&e!=null&&e.length>0&&i!=null&&i.length>0?new h(t,e,i):null}async backup(t){const e=new Tt(this.host,this.userId,this.appId);await e.setItem(h.BUCKET_ID_META,Dt,JSON.stringify(t.modified)),await e.setItem(h.BUCKET_ID_SETTINGS,bt,JSON.stringify(t.settings));const i=t.tasks.map(l=>l.id);await e.setItem(h.BUCKET_ID_TASKS,ot,JSON.stringify(i));for(const l of t.tasks)await e.setItem(h.BUCKET_ID_TASKS,l.id,JSON.stringify(l));const r=t.invoices.map(l=>l.id);await e.setItem(h.BUCKET_ID_INVOICES,ot,JSON.stringify(r));for(const l of t.invoices)await e.setItem(h.BUCKET_ID_INVOICES,l.id,JSON.stringify(l))}async getStoredValueOrDefault(t,e,i,r){try{const l=await t.getItem(e,i);if(l==null)return r;const p=JSON.parse(l);return p??r}catch{return r}}async getStoredValueOrThrow(t,e,i){try{const r=await t.getItem(e,i),l=JSON.parse(r);if(l==null)throw new Error(`Object is undefined after parsing and casting. JSON: ${r}`);return l}catch(r){throw new Error(`Unable to get stored value for key ${i} in bucket ${e}. ${r}`)}}async getData(){const t=new Tt(this.host,this.userId,this.appId),e=await this.getStoredValueOrDefault(t,h.BUCKET_ID_META,Dt,0);if(e==0)return null;let i=await this.getStoredValueOrDefault(t,h.BUCKET_ID_SETTINGS,bt,new v().getModel());const r=await this.getStoredValueOrDefault(t,h.BUCKET_ID_TASKS,ot,[]),l=[];for await(const I of r)try{const g=await this.getStoredValueOrThrow(t,h.BUCKET_ID_TASKS,I);l.push(g)}catch(g){console.error(g)}const p=await this.getStoredValueOrDefault(t,h.BUCKET_ID_INVOICES,ot,[]),S=[];for await(const I of p)try{const g=await this.getStoredValueOrThrow(t,h.BUCKET_ID_INVOICES,I);S.push(g)}catch(g){console.error(g)}return{modified:e,settings:i,tasks:l,invoices:S}}};f(h,"BUCKET_ID_META","meta"),f(h,"BUCKET_ID_SETTINGS","settings"),f(h,"BUCKET_ID_TASKS","tasks"),f(h,"BUCKET_ID_INVOICES","invoices");let pt=h;class xt{static async convertFileToDataURL(t){return new Promise((e,i)=>{const r=new FileReader;r.onloadend=()=>{const l=r.result;return e(l)},r.onerror=i,r.readAsDataURL(t)})}static downloadAsFile(t,e){const i=new Blob([t],{type:"text/plain"}),r=document.createElement("a");r.href=URL.createObjectURL(i),r.download=e,r.click(),URL.revokeObjectURL(r.href)}static sortByProperties(t,e){return t.sort((i,r)=>{for(let l of e){const[p,S]=l.split(":"),I=i[p],g=r[p];if(I<g)return S==="desc"?1:-1;if(I>g)return S==="desc"?-1:1}return 0})}}class Mt{async backup(t){const e=this.encode(t);this.downloadAsFile(e,t.settings.label)}downloadAsFile(t,e){const r=`${e?`${e}-`:""}${new Date().valueOf()}.timely-backup`;xt.downloadAsFile(t,r)}encode(t){return JSON.stringify(t,null,2)}decodeFromJson(t){return JSON.parse(t)}}var nt,rt;class Nt{constructor(){f(this,"settingsRepo");f(this,"taskRepo");f(this,"invRepo");f(this,"settingsController");o(this,nt,u(0));o(this,rt,u(n(new v)));const t={onModifiedCallback:()=>this.setChangedTimestamp()};this.settingsRepo=new gt(Ut,t),this.taskRepo=new gt(Lt,t),this.invRepo=new gt(At,t),this.settingsController=new mt(this.settingsRepo),this.settings=this.settingsController.read(),this.dataModifiedTimestamp=this.readDataModifiedTimestamp()??0}get dataModifiedTimestamp(){return a(s(this,nt))}set dataModifiedTimestamp(t){c(s(this,nt),n(t))}get settings(){return a(s(this,rt))}set settings(t){c(s(this,rt),n(t))}saveSettings(){this.settingsController.write(this.settings)}getScratchPad(t){return this.settings.scratchPads[t]??""}setScratchPad(t,e){this.settings.scratchPads[t]=e,this.saveSettings()}incrementNextInvoiceNumber(){this.settings.nextInvoiceNumber++,this.saveSettings()}async getTasks(){return this.taskRepo.getAll().map(t=>new Et(t))}async getInvoices(){return this.invRepo.getAll().map(t=>new vt(t))}async getInvoiceById(t){const e=this.invRepo.get(t);return e?new vt(e):null}getAppData(){return{modified:this.readDataModifiedTimestamp()??0,settings:this.settingsController.read().getModel(),tasks:this.taskRepo.getAll(),invoices:this.invRepo.getAll()}}setChangedTimestamp(t){this.dataModifiedTimestamp=t??new Date().valueOf(),localStorage.setItem("_modified",this.dataModifiedTimestamp.toString())}readDataModifiedTimestamp(){const t=localStorage.getItem("_modified");if(t===null)return null;const e=parseInt(t);return isNaN(e)?null:(this.dataModifiedTimestamp=e,e)}async backupData(t){const e=this.getAppData(),i=this.settingsController.read(),r=pt.build(i.cloudSyncHost,i.cloudSyncUserId,kt);if((t==="auto"||t==="cloud")&&r!=null){const l=await r.getData();if(l&&l.modified>=e.modified){await this.backupData("local");return}await r.backup(e),alert("Backup to cloud successful")}else t==="local"&&await new Mt().backup(e)}async restoreAppData(t){localStorage.clear(),this.setChangedTimestamp(t.modified),this.settings=new v(t.settings),this.saveSettings();for(const e of t.tasks)this.taskRepo.set(e.id,e);for(const e of t.invoices)this.invRepo.set(e.id,e)}}nt=new WeakMap,rt=new WeakMap;const Ot=new Nt;export{ft as F,vt as I,Tt as K,Mt as L,m as T,xt as U,Ot as a,kt as b,pt as c,Et as d,yt as e};
